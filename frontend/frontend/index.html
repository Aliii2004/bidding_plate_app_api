
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Plate Palooza</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e6e6e6;
        }
        
        .logo h1 {
            color: #2563eb;
            font-size: 2rem;
        }
        
        .logo p {
            color: #6b7280;
        }
        
        .auth-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .primary-btn {
            background-color: #2563eb;
            color: white;
        }
        
        .secondary-btn {
            background-color: transparent;
            color: #2563eb;
            border: 1px solid #2563eb !important;
            margin-left: 10px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #e6e6e6;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .tab.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 500;
        }
        
        .search-sort {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .search-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
        }
        
        .sort-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .plates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .plate-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .plate-card:hover {
            transform: translateY(-5px);
        }
        
        .plate-card-header {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .plate-card-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .plate-card-title h2 {
            font-size: 1.5rem;
            color: #333;
        }
        
        .plate-status {
            font-size: 0.7rem;
            background-color: #f3f4f6;
            color: #6b7280;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .plate-card-description {
            color: #6b7280;
            margin-bottom: 10px;
        }
        
        .plate-card-content {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .plate-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .info-label {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .info-value {
            font-weight: 500;
        }
        
        .plate-card-footer {
            padding: 15px;
        }
        
        .full-width-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #2563eb;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .full-width-btn:hover {
            background-color: #1d4ed8;
        }
        
        .full-width-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
            margin-bottom: 5px;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #6b7280;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }
        
        .modal-footer button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .close-btn {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        .submit-btn {
            background-color: #2563eb;
            color: white;
        }
        
        .bids-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .bid-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }
        
        .bid-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .bid-title {
            font-weight: 500;
            color: #333;
        }
        
        .bid-date {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .error-message, .success-message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        .error-message {
            background-color: #fee2e2;
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        
        .success-message {
            background-color: #dcfce7;
            color: #22c55e;
            border: 1px solid #22c55e;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            background-color: #f9fafb;
            border-radius: 10px;
            color: #6b7280;
        }
        
        footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid #e6e6e6;
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>Auto Plate Palooza</h1>
                <p>Bid on exclusive auto license plates - highest bid wins!</p>
            </div>
            <div class="auth-buttons">
                <button id="loginBtn" class="primary-btn">Login</button>
                <button id="logoutBtn" class="secondary-btn" style="display: none;">Logout</button>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" id="platesTab">Available Plates</div>
            <div class="tab" id="myBidsTab">My Bids</div>
        </div>

        <div id="platesContent">
            <div class="search-sort">
                <input type="text" id="searchInput" class="search-input" placeholder="Search plate number...">
                <select id="sortSelect" class="sort-select">
                    <option value="deadline">Deadline (Ascending)</option>
                    <option value="-deadline">Deadline (Descending)</option>
                </select>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>

            <div id="errorMessage" class="error-message"></div>

            <div id="platesGrid" class="plates-grid">
                <!-- Plates will be dynamically inserted here -->
            </div>

            <div id="emptyState" class="empty-state" style="display: none;">
                No plates found matching your criteria
            </div>
        </div>

        <div id="myBidsContent" style="display: none;">
            <div id="bidsLoading" class="loading">
                <div class="spinner"></div>
            </div>

            <div id="bidsErrorMessage" class="error-message"></div>

            <div id="bidsList" class="bids-list">
                <!-- User bids will be dynamically inserted here -->
            </div>

            <div id="bidsEmptyState" class="empty-state" style="display: none;">
                You haven't placed any bids yet
            </div>
        </div>

        <footer>
            <p>&copy; 2023 Auto Plate Palooza. All rights reserved.</p>
        </footer>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login to Your Account</h2>
                <p>Enter your credentials to place bids on auto plates.</p>
            </div>
            <div id="loginErrorMessage" class="error-message"></div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" class="form-control" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="close-btn" id="closeLoginModal">Cancel</button>
                <button class="submit-btn" id="submitLogin">Login</button>
            </div>
        </div>
    </div>

    <!-- Bid Modal -->
    <div id="bidModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Place a Bid</h2>
                <p id="bidPlateInfo">You are bidding on plate: <strong id="bidPlateNumber"></strong></p>
                <p>Current highest bid: <strong id="currentHighestBid"></strong></p>
            </div>
            <div id="bidErrorMessage" class="error-message"></div>
            <div id="bidSuccessMessage" class="success-message"></div>
            <div class="modal-body">
                <form id="bidForm">
                    <input type="hidden" id="plateId">
                    <div class="form-group">
                        <label for="bidAmount">Your Bid Amount ($)</label>
                        <input type="number" id="bidAmount" class="form-control" placeholder="Enter amount" step="0.01" min="0.01" required>
                        <small>Your bid must be higher than the current highest bid.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="close-btn" id="closeBidModal">Cancel</button>
                <button class="submit-btn" id="submitBid">Submit Bid</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = "http://localhost:8000";
        let authToken = localStorage.getItem('token') || '';
        let isLoggedIn = !!authToken;
        
        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const platesTab = document.getElementById('platesTab');
        const myBidsTab = document.getElementById('myBidsTab');
        const platesContent = document.getElementById('platesContent');
        const myBidsContent = document.getElementById('myBidsContent');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const platesGrid = document.getElementById('platesGrid');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const emptyState = document.getElementById('emptyState');
        const bidsList = document.getElementById('bidsList');
        const bidsLoading = document.getElementById('bidsLoading');
        const bidsErrorMessage = document.getElementById('bidsErrorMessage');
        const bidsEmptyState = document.getElementById('bidsEmptyState');
        
        // Modals
        const loginModal = document.getElementById('loginModal');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const submitLogin = document.getElementById('submitLogin');
        const loginForm = document.getElementById('loginForm');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        
        const bidModal = document.getElementById('bidModal');
        const closeBidModal = document.getElementById('closeBidModal');
        const submitBid = document.getElementById('submitBid');
        const bidForm = document.getElementById('bidForm');
        const bidErrorMessage = document.getElementById('bidErrorMessage');
        const bidSuccessMessage = document.getElementById('bidSuccessMessage');
        const bidPlateNumber = document.getElementById('bidPlateNumber');
        const currentHighestBid = document.getElementById('currentHighestBid');
        const plateIdInput = document.getElementById('plateId');
        
        // Update UI based on login state
        function updateAuthUI() {
            if (isLoggedIn) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                myBidsTab.style.display = 'block';
            } else {
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                myBidsTab.style.display = 'none';
                // If on my bids tab, switch to plates tab
                if (myBidsTab.classList.contains('active')) {
                    activateTab(platesTab);
                }
            }
        }
        
        // Format date for display
        function formatDate(dateString) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Check if plate bidding is closed (deadline passed)
        function isBiddingClosed(deadline) {
            return new Date(deadline) < new Date();
        }
        
        // Fetch plates from API
        async function fetchPlates() {
            loading.style.display = 'flex';
            errorMessage.style.display = 'none';
            emptyState.style.display = 'none';
            platesGrid.innerHTML = '';
            
            const searchTerm = searchInput.value.trim();
            const orderBy = sortSelect.value;
            
            try {
                let url = `${API_URL}/plates/?ordering=${orderBy}`;
                if (searchTerm) {
                    url += `&plate_numbercontains=${searchTerm}`;
                }
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error("Failed to fetch plates");
                }
                
                const plates = await response.json();
                
                if (plates.length === 0) {
                    emptyState.style.display = 'block';
                } else {
                    displayPlates(plates);
                }
            } catch (err) {
                console.error('Error fetching plates:', err);
                errorMessage.textContent = 'Failed to load plates. Please try again later.';
                errorMessage.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Display plates in the grid
        function displayPlates(plates) {
            platesGrid.innerHTML = '';
            
            plates.forEach(plate => {
                const isClosedClass = isBiddingClosed(plate.deadline) ? 'bg-gray-100' : '';
                
                const plateCard = document.createElement('div');
                plateCard.className = `plate-card ${isClosedClass}`;
                
                plateCard.innerHTML = `
                    <div class="plate-card-header">
                        <div class="plate-card-title">
                            <h2>${plate.plate_number}</h2>
                            ${isBiddingClosed(plate.deadline) ? '<span class="plate-status">Closed</span>' : ''}
                        </div>
                        <p class="plate-card-description">${plate.description}</p>
                    </div>
                    <div class="plate-card-content">
                        <div class="plate-info-row">
                            <span class="info-label">Deadline:</span>
                            <span class="info-value">${formatDate(plate.deadline)}</span>
                        </div>
                        <div class="plate-info-row">
                            <span class="info-label">Current Bid:</span>
                            <span class="info-value">${plate.highest_bid ? `$${parseFloat(plate.highest_bid).toFixed(2)}` : 'No bids yet'}</span>
                        </div>
                    </div>
                    <div class="plate-card-footer">
                        <button class="full-width-btn bid-button" 
                            data-plate-id="${plate.id}" 
                            data-plate-number="${plate.plate_number}" 
                            data-highest-bid="${plate.highest_bid || 0}" 
                            ${isBiddingClosed(plate.deadline) ? 'disabled' : ''}>
                            Place Bid
                        </button>
                    </div>
                `;
                
                platesGrid.appendChild(plateCard);
            });
            
            // Add event listeners to bid buttons
            document.querySelectorAll('.bid-button').forEach(button => {
                button.addEventListener('click', function() {
                    if (!isLoggedIn) {
                        openLoginModal();
                        return;
                    }
                    
                    const plateId = this.getAttribute('data-plate-id');
                    const plateNumber = this.getAttribute('data-plate-number');
                    const highestBid = this.getAttribute('data-highest-bid');
                    
                    openBidModal(plateId, plateNumber, highestBid);
                });
            });
        }
        
        // Fetch user bids
        async function fetchUserBids() {
            if (!isLoggedIn) return;
            
            bidsLoading.style.display = 'flex';
            bidsErrorMessage.style.display = 'none';
            bidsEmptyState.style.display = 'none';
            bidsList.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/bids/`, {
                    headers: {
                        Authorization: `Bearer ${authToken}`,
                    },
                });
                
                if (!response.ok) {
                    throw new Error("Failed to fetch user bids");
                }
                
                const bids = await response.json();
                
                if (bids.length === 0) {
                    bidsEmptyState.style.display = 'block';
                } else {
                    displayUserBids(bids);
                }
            } catch (err) {
                console.error('Error fetching user bids:', err);
                bidsErrorMessage.textContent = 'Failed to load your bids. Please try again later.';
                bidsErrorMessage.style.display = 'block';
            } finally {
                bidsLoading.style.display = 'none';
            }
        }
        
        // Display user bids
        function displayUserBids(bids) {
            bidsList.innerHTML = '';
            
            bids.forEach(bid => {
                const bidCard = document.createElement('div');
                bidCard.className = 'bid-card';
                
                bidCard.innerHTML = `
                    <div class="bid-header">
                        <span class="bid-title">Bid #${bid.id}</span>
                        <span class="bid-date">${formatDate(bid.created_at)}</span>
                    </div>
                    <div class="plate-info-row">
                        <span class="info-label">Plate ID:</span>
                        <span class="info-value">${bid.plate_id}</span>
                    </div>
                    <div class="plate-info-row">
                        <span class="info-label">Your Bid:</span>
                        <span class="info-value">$${parseFloat(bid.amount).toFixed(2)}</span>
                    </div>
                `;
                
                bidsList.appendChild(bidCard);
            });
        }
        
        // Login function
        async function login(username, password) {
            try {
                const formData = new FormData();
                formData.append("username", username);
                formData.append("password", password);
                
                const response = await fetch(`${API_URL}/login/`, {
                    method: "POST",
                    body: formData,
                });
                
                if (!response.ok) {
                    throw new Error("Login failed");
                }
                
                const data = await response.json();
                authToken = data.access_token;
                localStorage.setItem('token', authToken);
                isLoggedIn = true;
                
                // Update UI
                updateAuthUI();
                closeLoginModal();
                
                // Show success message
                alert("You have successfully logged in");
                
                // Reset form
                loginForm.reset();
            } catch (err) {
                console.error('Login error:', err);
                loginErrorMessage.textContent = 'Invalid username or password';
                loginErrorMessage.style.display = 'block';
            }
        }
        
        // Logout function
        function logout() {
            authToken = '';
            localStorage.removeItem('token');
            isLoggedIn = false;
            
            // Update UI
            updateAuthUI();
            
            // Show success message
            alert("You have been logged out");
        }
        
        // Place bid function
        async function placeBid(plateId, amount) {
            try {
                const response = await fetch(`${API_URL}/bids/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${authToken}`,
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        plate_id: parseInt(plateId),
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || "Failed to place bid");
                }
                
                // Show success message
                bidSuccessMessage.textContent = 'Your bid has been successfully placed';
                bidSuccessMessage.style.display = 'block';
                bidErrorMessage.style.display = 'none';
                
                // Refresh plates
                fetchPlates();
                
                // Close modal after a delay
                setTimeout(() => {
                    closeBidModal();
                }, 2000);
                
                // Reset form
                bidForm.reset();
            } catch (err) {
                console.error('Bid error:', err);
                bidErrorMessage.textContent = err.message;
                bidErrorMessage.style.display = 'block';
                bidSuccessMessage.style.display = 'none';
            }
        }
        
        // Open login modal
        function openLoginModal() {
            loginModal.style.display = 'flex';
            loginErrorMessage.style.display = 'none';
        }
        
        // Close login modal
        function closeLoginModal() {
            loginModal.style.display = 'none';
            loginForm.reset();
        }
        
        // Open bid modal
        function openBidModal(plateId, plateNumber, highestBid) {
            plateIdInput.value = plateId;
            bidPlateNumber.textContent = plateNumber;
            currentHighestBid.textContent = highestBid > 0 ? `$${parseFloat(highestBid).toFixed(2)}` : 'No bids yet';
            
            bidErrorMessage.style.display = 'none';
            bidSuccessMessage.style.display = 'none';
            
            bidModal.style.display = 'flex';
        }
        
        // Close bid modal
        function closeBidModal() {
            bidModal.style.display = 'none';
            bidForm.reset();
        }
        
        // Switch tabs
        function activateTab(tab) {
            // Update tab styles
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Show/hide content
            if (tab === platesTab) {
                platesContent.style.display = 'block';
                myBidsContent.style.display = 'none';
                fetchPlates();
            } else {
                platesContent.style.display = 'none';
                myBidsContent.style.display = 'block';
                fetchUserBids();
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Update UI based on login state
            updateAuthUI();
            
            // Load initial data
            fetchPlates();
            
            // Event listeners for tabs
            platesTab.addEventListener('click', function() {
                activateTab(platesTab);
            });
            
            myBidsTab.addEventListener('click', function() {
                if (!isLoggedIn) {
                    openLoginModal();
                    return;
                }
                activateTab(myBidsTab);
            });
            
            // Event listeners for search and sort
            searchInput.addEventListener('input', debounce(fetchPlates, 500));
            sortSelect.addEventListener('change', fetchPlates);
            
            // Login button
            loginBtn.addEventListener('click', openLoginModal);
            
            // Logout button
            logoutBtn.addEventListener('click', logout);
            
            // Login modal
            closeLoginModal.addEventListener('click', closeLoginModal);
            submitLogin.addEventListener('click', function() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                login(username, password);
            });
            
            // Bid modal
            closeBidModal.addEventListener('click', closeBidModal);
            submitBid.addEventListener('click', function() {
                const plateId = plateIdInput.value;
                const amount = document.getElementById('bidAmount').value;
                placeBid(plateId, amount);
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === loginModal) {
                    closeLoginModal();
                } else if (event.target === bidModal) {
                    closeBidModal();
                }
            });
        });
        
        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
    </script>
</body>
</html>
